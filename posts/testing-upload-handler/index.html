<!doctype html>
<html lang="es">
<head>
    
    <meta charset="UTF-8" />
    <title>{ federico-arias }  | Testing a file upload handler in Golang</title> 
	
	<link rel="stylesheet" href="https://federico-arias.github.io/sass/main.min.css"/>
    
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
	
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-127821516-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>

<body>

    <header>
        <div class="nav-header">
            <div class="nav-header__logo">
				<a href="https://federico-arias.github.io"><img src="/logo.png" alt="web site logo"/></a>
            </div>
            <div class="nav-header__desc">
                <h1>
					<a href="https://federico-arias.github.io">{ federico-arias } </a>
                </h1>
            </div>

			
			<ul class="nav-menu">
				
				<li class="">
					<a href="https://federico-arias.github.io" title="home">home</a></li>
				
				<li class="">
					<a href="https://federico-arias.github.io/about" title="about">about</a></li>
				
				<li class="">
					<a href="https://federico-arias.github.io/hireme" title="hire me">hire me</a></li>
				
			</ul>

        </div>
    </header>


    <article>
        <h1>Testing a file upload handler in Golang</h1>
		
            <p>There are <a href="https://undebugable.wordpress.com/2017/04/15/golang-simple-file-upload-using-go-languange/">multiple</a> <a href="https://zupzup.org/go-http-file-upload-download/">examples</a> around the web about uploading a file in Go. Not so many about testing these type of handlers. Below, you can find an example of a simple way of testing your handler.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestUploadImage</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">//Set up a pipe to avoid buffering
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pr</span>, <span style="color:#a6e22e">pw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Pipe</span>()
	<span style="color:#75715e">//This writers is going to transform 
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//what we pass to it to multipart form data
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//and write it to our io.Pipe
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">writer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">multipart</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">pw</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">Close</span>()
		<span style="color:#75715e">//we create the form data field &#39;fileupload&#39;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//wich returns another writer to write the actual file 
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">part</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">CreateFormFile</span>(<span style="color:#e6db74">&#34;fileupload&#34;</span>, <span style="color:#e6db74">&#34;someimg.png&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		}

		<span style="color:#75715e">//https://yourbasic.org/golang/create-image/
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">img</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">createImage</span>()

		<span style="color:#75715e">//Encode() takes an io.Writer.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//We pass the multipart field
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//&#39;fileupload&#39; that we defined
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//earlier which, in turn, writes
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//to our io.Pipe
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">png</span>.<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">part</span>, <span style="color:#a6e22e">img</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		}
	}()

	<span style="color:#75715e">//We read from the pipe which receives data
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//from the multipart writer, which, in turn,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//receives data from png.Encode().
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//We have 3 chained writers !
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">request</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httptest</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#e6db74">&#34;POST&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">pr</span>)
	<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">FormDataContentType</span>())

	<span style="color:#a6e22e">response</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httptest</span>.<span style="color:#a6e22e">NewRecorder</span>()
	<span style="color:#a6e22e">handler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UploadFileHandler</span>()
	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">response</span>, <span style="color:#a6e22e">request</span>)

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;It should respond with an HTTP status code of 200&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">Code</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Expected %s, received %d&#34;</span>, <span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">Code</span>)
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;It should create a file named &#39;someimg.png&#39; in uploads folder&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#e6db74">&#34;./uploads/someimg.png&#34;</span>); <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">IsNotExist</span>(<span style="color:#a6e22e">err</span>) {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;Expected file ./uploads/someimg.png&#39; to exist&#34;</span>)
	}
}</code></pre></div>
    </article>
    
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "federico-arias-disqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div class="footer">
<p>
<hr></hr>
</p> 
</div>
<script src="https://unpkg.com/github-calendar@latest/dist/github-calendar.min.js"></script>
<script>GitHubCalendar(".calendar", "federico-arias", { responsive: true }); </script>



</body>
</html>
